<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Hiraeth Calendar</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* Custom scrollbar for webkit browsers */
        ::-webkit-scrollbar {
            width: 8px;
            height: 8px;
        }
        ::-webkit-scrollbar-track {
            background: #f1f1f1;
            border-radius: 10px;
        }
        ::-webkit-scrollbar-thumb {
            background: #888;
            border-radius: 10px;
        }
        ::-webkit-scrollbar-thumb:hover {
            background: #555;
        }
        .dark ::-webkit-scrollbar-track {
            background: #2d3748; /* dark:bg-gray-700 */
        }
        .dark ::-webkit-scrollbar-thumb {
            background: #718096; /* dark:bg-gray-500 */
        }
        .dark ::-webkit-scrollbar-thumb:hover {
            background: #a0aec0; /* dark:bg-gray-400 */
        }

        .calendar-grid {
            display: grid;
            grid-template-columns: repeat(7, minmax(0, 1fr));
            gap: 1px; /* This gap + the grid background color creates the cell borders */
        }
        .calendar-cell {
            min-height: 120px; /* Adjusted min-height for potentially more content */
        }
        .event-marker {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            margin-right: 4px;
            flex-shrink: 0; /* Prevent dot from shrinking */
        }
        /* For modal */
        .modal-backdrop {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5); /* Semi-transparent backdrop */
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 50; /* Ensure modal is on top */
        }
        .modal-content {
            max-height: 80vh; /* Limit modal height */
            overflow-y: auto; /* Allow scrolling for tall content */
        }

        .weekend-header {
            background-color: #e2e8f0; /* Tailwind's bg-slate-200 */
            font-weight: 600; /* semibold */
        }
        .dark .weekend-header {
            background-color: #4a5568; /* Tailwind's dark:bg-slate-600 */
        }
        .weekend-day-cell {
            background-color: #f7fafc; /* Tailwind's bg-gray-50 */
        }
        .dark .weekend-day-cell {
            background-color: #2c3340; /* Custom dark weekend color */
        }
        /* Styling for event list in modal */
        #search-results-list li, #modal-event-list li, .settings-modal-section div {
            padding: 8px;
            border-bottom: 1px solid #e5e7eb; /* dark:border-gray-700 */
        }
        .dark #search-results-list li, .dark #modal-event-list li, .dark .settings-modal-section div {
             border-bottom: 1px solid #374151; /* dark:border-gray-600 */
        }
        #search-results-list li:last-child, #modal-event-list li:last-child, .settings-modal-section div:last-child {
            border-bottom: none;
        }
        .settings-modal-section h4 {
            @apply text-lg font-semibold mb-2 text-gray-700 dark:text-gray-300 pt-2;
        }
        #loading-status-in-settings {
            @apply text-sm text-gray-500 dark:text-gray-400 mb-3 pb-2 border-b border-gray-200 dark:border-gray-700;
        }
    </style>
</head>
<body class="font-sans antialiased transition-colors duration-300 ease-in-out bg-gray-100 dark:bg-gray-900">

    <div id="app-container" class="min-h-screen text-gray-800 dark:text-gray-200 p-4 transition-colors duration-300 ease-in-out">
        <header class="navigation-controls mb-6 p-4 bg-white dark:bg-gray-800 rounded-lg shadow transition-colors duration-300 ease-in-out">
            <div class="flex flex-wrap items-center justify-between gap-x-6 gap-y-3">
                <div class="flex items-center space-x-2 sm:space-x-4">
                    <button id="prev-month" class="px-3 py-2 sm:px-4 bg-blue-500 hover:bg-blue-600 text-white rounded-md shadow">&lt; Prev</button>
                    <div class="text-center">
                        <h2 id="current-month-year" class="text-xl md:text-2xl font-semibold min-w-[160px] sm:min-w-[180px]"></h2>
                        <p id="current-year-month-numeric" class="text-xs text-gray-500 dark:text-gray-400"></p>
                    </div>
                    <button id="next-month" class="px-3 py-2 sm:px-4 bg-blue-500 hover:bg-blue-600 text-white rounded-md shadow">Next &gt;</button>
                </div>

                <div id="zodiac-display" class="text-center text-sm sm:text-base font-medium text-indigo-600 dark:text-indigo-400 transition-colors duration-300 ease-in-out w-full lg:w-auto order-first lg:order-none">
                    </div>

                <div class="flex items-center space-x-2 sm:space-x-4">
                    <button id="settings-button" class="px-3 py-2 bg-indigo-500 hover:bg-indigo-600 text-white rounded-md shadow text-sm sm:text-base">‚öôÔ∏è Settings</button>
                    <button id="search-button" class="px-3 py-2 bg-cyan-500 hover:bg-cyan-600 text-white rounded-md shadow text-sm sm:text-base">üîç Search</button>
                    <button id="today-button" class="px-3 py-2 bg-green-500 hover:bg-green-600 text-white rounded-md shadow text-sm sm:text-base">Today</button>
                    <button id="lore-button" class="px-3 py-2 bg-purple-500 hover:bg-purple-600 text-white rounded-md shadow text-sm sm:text-base">Hiraeth Lore</button>
                </div>
            </div>
            </header>

        <main id="calendar-view" class="bg-white dark:bg-gray-800 p-1 rounded-lg shadow transition-colors duration-300 ease-in-out">
            <div id="month-grid-header" class="calendar-grid bg-gray-300 dark:bg-gray-600 mb-1 rounded-t-md transition-colors duration-300 ease-in-out">
            </div>
            <div id="month-grid-days" class="calendar-grid bg-gray-300 dark:bg-gray-600 rounded-b-md transition-colors duration-300 ease-in-out">
            </div>
        </main>

        <div id="event-modal" class="modal-backdrop hidden">
            <div class="modal-content bg-white dark:bg-gray-800 p-6 rounded-lg shadow-xl w-11/12 md:w-2/3 lg:w-1/2 transition-colors duration-300 ease-in-out">
                <div class="flex justify-between items-center mb-4">
                    <h3 id="modal-title" class="text-2xl font-semibold">Details</h3>
                    <button id="close-modal" class="text-gray-600 dark:text-gray-400 hover:text-red-500 dark:hover:text-red-400 text-2xl">&times;</button>
                </div>
                <div id="modal-body" class="space-y-3">
                </div>
            </div>
        </div>
    </div>

    <script>
        // --- HIRAETH CALENDAR CONFIGURATION ---
        const HIRAETH_CONFIG = {
            daysOfWeek: ["Pythda", "Minda", "Voida", "Ethearda", "Nyda", "Hestda", "Bethda"],
            weekendDays: ["Hestda", "Bethda"],
            months: [
                { name: "Novnus", days: 30, zodiac: "Matrix (The Hero)", zodiacInfo: "Represents a hero foretold in prophecy..." },
                { name: "Ultcicero", days: 30, zodiac: "The Son (Prince)", zodiacInfo: "Represents the power of fate..." },
                { name: "Concis", days: 30, zodiac: "The Phoenix (Reborn/Rebirth)", zodiacInfo: "Symbolizes rebirth..." },
                { name: "Rifis", days: 30, zodiac: "The Frog", zodiacInfo: "Represents impatience..." },
                { name: "Inder", days: 30, zodiac: "The Hammer", zodiacInfo: "Associated with tales of betrayal..." },
                { name: "Gradum", days: 30, zodiac: "The Leaf", zodiacInfo: "Represents affinity for water..." },
                { name: "Tristis", days: 30, zodiac: "The Horse", zodiacInfo: "Represents remnants of lost cultures..." },
                { name: "Mutare", days: 30, zodiac: "The Ship", zodiacInfo: "Symbolizes betrayal..." },
                { name: "Harolds", days: 30, zodiac: "The Iris", zodiacInfo: "Represents a great villain..." },
                { name: "Umbra", days: 30, zodiac: "The Cart", zodiacInfo: "Represents the power of a certain god..." },
                { name: "Galious", days: 30, zodiac: "The Snow Wolf", zodiacInfo: "Symbolizes loyalty..." },
                { name: "Nocturum", days: 30, zodiac: "The Knights", zodiacInfo: "Represents loyalty..." }
            ],
            primaryMoon: {
                name: "Luminus",
                cycle: 15,
                shift: 9,
                granularity: 8,
                phases: ["üåë", "üåí", "üåì", "üåî", "üåï", "üåñ", "üåó", "üåò"]
            },
            calendarEpochStart: { year: 1, month: 0, day: 1 },
            loreText: `
                <h4 class="text-xl font-semibold mb-2 text-gray-800 dark:text-gray-100">Hiraeth Time System</h4>
                <p class="mb-2 text-gray-700 dark:text-gray-300">Dates are written YY-MM-DD. The days and months are unique to Hiraeth.</p>
                <h5 class="text-lg font-semibold mt-3 mb-1 text-gray-800 dark:text-gray-100">Days of the Week:</h5>
                <ul class="list-disc list-inside mb-2 text-gray-700 dark:text-gray-300">
                    <li>Pythda: Named after the Goddess of life Pythia.</li>
                    <li>Minda: Named after the God of time Minos.</li>
                    <li>Voida: Named after the God of Space Voidos.</li>
                    <li>Ethearda: Named after the Goddess of the Stars Etherea.</li>
                    <li>Nyda: Named after the Goddess of Night Nyx.</li>
                    <li>Hestda: Named after the Goddess of the hearth Hesta. (Weekend)</li>
                    <li>Bethda: Named after the god the sun Bethtox. (Weekend)</li>
                </ul>
                <h5 class="text-lg font-semibold mt-3 mb-1 text-gray-800 dark:text-gray-100">Zodiac Signs & Meanings:</h5>
                <p class="mb-2 text-gray-700 dark:text-gray-300">Each month has a corresponding Zodiac sign with unique characteristics and lore. (Details shown with month)</p>
                <h4 class="text-xl font-semibold mt-4 mb-2 text-gray-800 dark:text-gray-100">Timekeeping in Hiraeth</h4>
                <p class="mb-2 text-gray-700 dark:text-gray-300">Passage of time can vary across different planes. Magic can also manipulate time.</p>
                <h4 class="text-xl font-semibold mt-4 mb-2 text-gray-800 dark:text-gray-100">Timelines & Birthdays</h4>
                <p class="mb-2 text-gray-700 dark:text-gray-300">Hiraeth has multiple timelines. Birthdays can be celebrated with specific conditions.</p>
            `
        };

        // --- APPLICATION STATE (DEFAULTS) ---
        let hiraethYear = 76;
        let hiraethMonth = 2;
        let hiraethDay = 21;
        let showMoonPhases = true;
        let calendarLoadingStatusMessage = "Loading calendars..."; // MODIFICATION: Store status message

        const calendarFilesToLoad = [
            "../calendars/sample_hiraeth_events.json",
            "../calendars/Curse-of-the-Bloodwrite.json"
        ];

        let allCalendarsData = {};
        let activeCalendars = new Set();

        // --- DOM ELEMENTS ---
        const appContainer = document.getElementById('app-container');
        const currentMonthYearEl = document.getElementById('current-month-year');
        const currentYearMonthNumericEl = document.getElementById('current-year-month-numeric');
        const monthGridHeaderEl = document.getElementById('month-grid-header');
        const monthGridDaysEl = document.getElementById('month-grid-days');
        const zodiacDisplayEl = document.getElementById('zodiac-display');
        const prevMonthButton = document.getElementById('prev-month');
        const nextMonthButton = document.getElementById('next-month');
        const todayButton = document.getElementById('today-button');
        const loreButton = document.getElementById('lore-button');
        const searchButton = document.getElementById('search-button');
        const settingsButton = document.getElementById('settings-button');
        const eventModal = document.getElementById('event-modal');
        const modalTitle = document.getElementById('modal-title');
        const modalBody = document.getElementById('modal-body');
        const closeModalButton = document.getElementById('close-modal');
        // MODIFICATION: Removed loadingCalendarsMessageEl as it's no longer in main HTML

        // --- THEME HANDLING ---
        function setInitialTheme() {
            const storedTheme = localStorage.getItem('hiraethCalendarTheme');
            if (storedTheme) {
                document.documentElement.classList.toggle('dark', storedTheme === 'dark');
                document.documentElement.style.colorScheme = storedTheme;
            } else if (window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches) {
                document.documentElement.classList.add('dark');
                document.documentElement.style.colorScheme = 'dark';
            } else {
                document.documentElement.classList.remove('dark');
                document.documentElement.style.colorScheme = 'light';
            }
        }
        function toggleTheme() {
            const isDark = document.documentElement.classList.toggle('dark');
            const newTheme = isDark ? 'dark' : 'light';
            document.documentElement.style.colorScheme = newTheme;
            localStorage.setItem('hiraethCalendarTheme', newTheme);
        }

        // --- UTILITY FUNCTIONS ---
        function hiraethDateToGlobalEpochDays(year, monthIndex, dayOfMonth) {
            let totalDays = 0;
            for (let y = HIRAETH_CONFIG.calendarEpochStart.year; y < year; y++) {
                totalDays += HIRAETH_CONFIG.months.reduce((sum, m) => sum + getHiraethDaysInMonth(y, HIRAETH_CONFIG.months.indexOf(m)), 0);
            }
            for (let m = 0; m < monthIndex; m++) {
                totalDays += getHiraethDaysInMonth(year, m);
            }
            totalDays += dayOfMonth;
            return totalDays;
        }
        function isHiraethLeapYear(year) { return false; }
        function getHiraethDaysInMonth(year, monthIndex) {
            if (monthIndex < 0 || monthIndex >= HIRAETH_CONFIG.months.length) {
                console.error(`[getHiraethDaysInMonth] Invalid monthIndex: ${monthIndex} for year: ${year}. Defaulting to 30 days.`);
                return 30;
            }
            return HIRAETH_CONFIG.months[monthIndex].days;
        }
        function getLuminusMoonPhase(year, month, day) {
            const currentGlobalEpochDay = hiraethDateToGlobalEpochDays(year, month, day);
            const moon = HIRAETH_CONFIG.primaryMoon;
            const dayForCycleCalc = currentGlobalEpochDay -1;
            const dayInCycle = (dayForCycleCalc + moon.shift) % moon.cycle;
            const phaseValue = dayInCycle / moon.cycle;
            const phaseIndex = Math.floor(phaseValue * moon.granularity);
            return phaseIndex < moon.phases.length ? phaseIndex : moon.phases.length -1 ;
        }

        // --- MODAL HANDLING ---
        function openModal(title, contentHtml, isSettingsModal = false) {
            if (modalTitle) modalTitle.textContent = title;
            if (modalBody) modalBody.innerHTML = contentHtml;
            if (isSettingsModal) {
                addSettingsModalEventListeners();
            }
            if (eventModal) eventModal.classList.remove('hidden');
        }
        function closeModal() {
            if (eventModal) eventModal.classList.add('hidden');
        }

        // --- EVENT DATA MANAGEMENT & SETTINGS MODAL ---
        function getVisibleEvents() {
            let visibleEvents = [];
            activeCalendars.forEach(calendarName => {
                if (allCalendarsData[calendarName]) {
                    visibleEvents = visibleEvents.concat(allCalendarsData[calendarName]);
                }
            });
            return visibleEvents;
        }

        function getCalendarTogglesHTML() {
            let togglesHTML = '<div class="settings-modal-section"><h4>Loaded Calendars</h4>';
            if (Object.keys(allCalendarsData).length === 0) {
                togglesHTML += '<p class="text-sm text-gray-500 dark:text-gray-400">No external calendars loaded.</p>';
            } else {
                Object.keys(allCalendarsData).sort().forEach(originalCalendarName => {
                    const checkboxId = `toggle-cal-${originalCalendarName.toLowerCase().replace(/\s+/g, '-').replace(/[^a-z0-9-]/g, '')}`;
                    const isChecked = activeCalendars.has(originalCalendarName);
                    togglesHTML += `
                        <div>
                            <label for="${checkboxId}" class="flex items-center space-x-2 cursor-pointer text-sm text-gray-700 dark:text-gray-300">
                                <input type="checkbox" id="${checkboxId}" data-calendar-name="${originalCalendarName}" ${isChecked ? 'checked' : ''} class="form-checkbox h-4 w-4 text-blue-600 dark:text-blue-500 bg-gray-100 dark:bg-gray-700 border-gray-300 dark:border-gray-600 rounded focus:ring-blue-500 dark:focus:ring-blue-600 focus:ring-offset-0 dark:focus:ring-offset-gray-800">
                                <span>${originalCalendarName}</span>
                            </label>
                        </div>`;
                });
            }
            togglesHTML += '</div>';
            return togglesHTML;
        }

        function getMoonPhaseToggleHTML() {
            return `
                <div class="settings-modal-section">
                    <h4>Display Options</h4>
                    <div>
                        <label for="modal-toggle-moon-phases" class="flex items-center space-x-2 cursor-pointer text-sm text-gray-700 dark:text-gray-300">
                            <input type="checkbox" id="modal-toggle-moon-phases" ${showMoonPhases ? 'checked' : ''} class="form-checkbox h-4 w-4 text-blue-600 dark:text-blue-500 bg-gray-100 dark:bg-gray-700 border-gray-300 dark:border-gray-600 rounded focus:ring-blue-500 dark:focus:ring-blue-600 focus:ring-offset-0 dark:focus:ring-offset-gray-800">
                            <span>Show Moon Phases</span>
                        </label>
                    </div>
                </div>`;
        }

        function openSettingsModal() {
            // MODIFICATION: Add loading status message to the settings modal
            const loadingStatusHTML = `<div id="loading-status-in-settings">${calendarLoadingStatusMessage}</div>`;
            const calendarTogglesHTML = getCalendarTogglesHTML();
            const moonPhaseToggleHTML = getMoonPhaseToggleHTML();
            openModal("Calendar Settings", loadingStatusHTML + calendarTogglesHTML + moonPhaseToggleHTML, true);
        }

        function addSettingsModalEventListeners() {
            if (!modalBody) return;
            modalBody.querySelectorAll('input[type="checkbox"][data-calendar-name]').forEach(checkbox => {
                checkbox.addEventListener('change', (e) => {
                    const calendarName = e.target.dataset.calendarName;
                    if (e.target.checked) activeCalendars.add(calendarName);
                    else activeCalendars.delete(calendarName);
                    renderCalendar();
                });
            });
            const moonToggle = modalBody.querySelector('#modal-toggle-moon-phases');
            if (moonToggle) {
                moonToggle.addEventListener('change', (e) => {
                    showMoonPhases = e.target.checked;
                    renderCalendar();
                });
            }
        }

        async function loadCalendarFile(filePath) {
            console.log(`[loadCalendarFile] Attempting to fetch: ${filePath}`);
            try {
                const response = await fetch(filePath);
                console.log(`[loadCalendarFile] Response status for ${filePath}: ${response.status}`);
                if (!response.ok) {
                    console.error(`[loadCalendarFile] HTTP error! Status: ${response.status} for ${filePath}.`);
                    throw new Error(`HTTP error! status: ${response.status} for ${filePath}`);
                }
                const events = await response.json();
                if (Array.isArray(events)) {
                    const rawFileName = filePath.split('/').pop().replace('.json', '');
                    const standardizedName = rawFileName.replace(/_/g, ' ')
                                                     .replace(/[^a-zA-Z0-9\s-]/g, ' ')
                                                     .replace(/\s+/g, ' ')
                                                     .trim();
                    const calendarKeyName = standardizedName || 'Unnamed Calendar';
                    allCalendarsData[calendarKeyName] = events;
                    console.log(`[loadCalendarFile] Successfully loaded and parsed: "${filePath}". Key: "${calendarKeyName}"`);
                    return { status: 'fulfilled', name: calendarKeyName };
                } else {
                    console.error(`[loadCalendarFile] Invalid JSON structure for ${filePath}. Expected an array.`);
                    return { status: 'rejected', name: filePath, reason: 'Invalid JSON array structure' };
                }
            } catch (error) {
                console.error(`[loadCalendarFile] Fetch or JSON parsing error for ${filePath}:`, error);
                return { status: 'rejected', name: filePath, reason: error.message || 'Failed to fetch or parse' };
            }
        }

        async function loadAllDefinedCalendars() {
            // MODIFICATION: Update global status message instead of a specific DOM element
            calendarLoadingStatusMessage = "Loading calendars...";
            if (calendarFilesToLoad.length === 0) {
                calendarLoadingStatusMessage = "No external calendars defined to load.";
                console.log("[loadAllDefinedCalendars] No calendar files to load.");
                return;
            }

            console.log("[loadAllDefinedCalendars] Starting to load calendar files:", calendarFilesToLoad);
            const loadPromises = calendarFilesToLoad.map(filePath => loadCalendarFile(filePath));
            const results = await Promise.allSettled(loadPromises);
            let loadedCount = 0;
            results.forEach(result => {
                if (result.status === 'fulfilled' && result.value.status === 'fulfilled') {
                    loadedCount++;
                }
            });

            if (loadedCount > 0) {
                calendarLoadingStatusMessage = `${loadedCount} of ${calendarFilesToLoad.length} external calendars loaded.`;
            } else {
                calendarLoadingStatusMessage = `Failed to load any external calendars. Check console.`;
            }
            console.log(`[loadAllDefinedCalendars] Finished loading. ${loadedCount} successful. Status: ${calendarLoadingStatusMessage}`);
        }


        // --- CALENDAR RENDERING ---
        function renderCalendar() {
            console.log("[renderCalendar] Attempting to render calendar...");
            try {
                if (isNaN(hiraethYear) || isNaN(hiraethMonth) || hiraethMonth < 0 || hiraethMonth >= HIRAETH_CONFIG.months.length || isNaN(hiraethDay)) {
                    console.error(`[renderCalendar] Invalid date state: Year=${hiraethYear}, Month=${hiraethMonth}, Day=${hiraethDay}. Resetting to defaults.`);
                    hiraethYear = 76; hiraethMonth = 2; hiraethDay = 21;
                }

                const monthData = HIRAETH_CONFIG.months[hiraethMonth];
                if (!monthData) {
                    console.error(`[renderCalendar] CRITICAL: monthData is undefined for hiraethMonth ${hiraethMonth}.`);
                    if (currentMonthYearEl) currentMonthYearEl.textContent = "Error: Invalid Month";
                    if (monthGridDaysEl) monthGridDaysEl.innerHTML = '<p class="p-4 text-red-500">Error: Month data unavailable.</p>';
                    return;
                }

                if (currentMonthYearEl) currentMonthYearEl.textContent = `${monthData.name}, ${String(hiraethYear).padStart(4, '0')}`;
                if (currentYearMonthNumericEl) currentYearMonthNumericEl.textContent = `${String(hiraethYear).padStart(4, '0')}-${String(hiraethMonth + 1).padStart(2, '0')}`;
                
                // MODIFICATION: Zodiac display content set here
                if (zodiacDisplayEl) {
                     zodiacDisplayEl.innerHTML = `
                        <strong class="block text-gray-800 dark:text-gray-100">${monthData.zodiac}</strong>
                        <span class="text-xs text-gray-600 dark:text-gray-400">${monthData.zodiacInfo}</span>`;
                }


                if (monthGridHeaderEl) {
                    monthGridHeaderEl.innerHTML = '';
                    HIRAETH_CONFIG.daysOfWeek.forEach(dayName => {
                        const dayCell = document.createElement('div');
                        dayCell.className = 'p-2 text-center font-semibold text-sm sm:text-base text-gray-700 dark:text-gray-300 bg-white dark:bg-gray-800';
                        if (HIRAETH_CONFIG.weekendDays.includes(dayName)) dayCell.classList.add('weekend-header');
                        dayCell.textContent = dayName;
                        monthGridHeaderEl.appendChild(dayCell);
                    });
                } else { console.error("[renderCalendar] monthGridHeaderEl not found."); }

                if (monthGridDaysEl) {
                    monthGridDaysEl.innerHTML = '';
                    const daysInMonth = getHiraethDaysInMonth(hiraethYear, hiraethMonth);
                    const firstDayGlobalEpoch = hiraethDateToGlobalEpochDays(hiraethYear, hiraethMonth, 1);
                    const firstDayOfWeek = (firstDayGlobalEpoch - 1 + HIRAETH_CONFIG.daysOfWeek.length) % HIRAETH_CONFIG.daysOfWeek.length;

                    for (let i = 0; i < firstDayOfWeek; i++) {
                        const emptyCell = document.createElement('div');
                        emptyCell.className = 'calendar-cell bg-gray-50 dark:bg-slate-700 border-transparent';
                        monthGridDaysEl.appendChild(emptyCell);
                    }

                    const currentVisibleEvents = getVisibleEvents();

                    for (let day = 1; day <= daysInMonth; day++) {
                        const cell = document.createElement('div');
                        cell.className = 'calendar-cell p-2 border-transparent cursor-pointer hover:bg-blue-100 dark:hover:bg-blue-900 relative bg-white dark:bg-gray-800 flex flex-col';

                        const currentDayGlobalEpoch = hiraethDateToGlobalEpochDays(hiraethYear, hiraethMonth, day);
                        const dayOfWeekIndex = (currentDayGlobalEpoch - 1 + HIRAETH_CONFIG.daysOfWeek.length) % HIRAETH_CONFIG.daysOfWeek.length;
                        if (HIRAETH_CONFIG.weekendDays.includes(HIRAETH_CONFIG.daysOfWeek[dayOfWeekIndex])) {
                            cell.classList.add('weekend-day-cell');
                            cell.classList.remove('bg-white', 'dark:bg-gray-800');
                        }

                        const topRowContainer = document.createElement('div');
                        topRowContainer.className = 'flex justify-between items-start w-full mb-1';

                        const dayNumberEl = document.createElement('span');
                        dayNumberEl.className = 'text-sm sm:text-base font-medium text-gray-900 dark:text-gray-100';
                        dayNumberEl.textContent = day;
                        topRowContainer.appendChild(dayNumberEl);

                        if (showMoonPhases) {
                            const moonPhaseIndex = getLuminusMoonPhase(hiraethYear, hiraethMonth, day);
                            const moonEmoji = HIRAETH_CONFIG.primaryMoon.phases[moonPhaseIndex];
                            const moonPhaseEl = document.createElement('div');
                            moonPhaseEl.className = 'text-lg text-gray-700 dark:text-gray-300 hidden sm:block';
                            moonPhaseEl.textContent = moonEmoji;
                            topRowContainer.appendChild(moonPhaseEl);
                        } else {
                            const moonPlaceholder = document.createElement('div');
                            moonPlaceholder.className = 'w-6 h-6';
                            topRowContainer.appendChild(moonPlaceholder);
                        }
                        cell.appendChild(topRowContainer);

                        const dateString = `${String(hiraethYear).padStart(4, '0')}-${String(hiraethMonth + 1).padStart(2, '0')}-${String(day).padStart(2, '0')}`;
                        const dayEvents = currentVisibleEvents.filter(event => event.date === dateString);

                        if (dayEvents.length > 0) {
                            const eventsContainer = document.createElement('div');
                            eventsContainer.className = 'w-full space-y-1 px-1 max-h-[calc(100%-2.5rem)] overflow-y-auto';

                            dayEvents.slice(0, 2).forEach(event => {
                                const eventMarker = document.createElement('div');
                                eventMarker.className = 'flex items-center text-xs p-1 bg-green-200 dark:bg-green-700 text-green-800 dark:text-green-100 rounded truncate cursor-pointer hover:bg-green-300 dark:hover:bg-green-600';
                                const markerDot = document.createElement('span');
                                markerDot.className = 'event-marker bg-green-500 dark:bg-green-400';
                                eventMarker.appendChild(markerDot);
                                const eventTitle = document.createElement('span');
                                eventTitle.className = 'truncate';
                                eventTitle.textContent = event.title;
                                eventMarker.appendChild(eventTitle);
                                eventMarker.addEventListener('click', (e) => {
                                    e.stopPropagation();
                                    showSingleEventDetails(event, hiraethYear, hiraethMonth, day);
                                });
                                eventsContainer.appendChild(eventMarker);
                            });
                            if (dayEvents.length > 2) {
                                const moreEventsEl = document.createElement('div');
                                moreEventsEl.className = 'text-xs text-blue-600 dark:text-blue-400 text-center font-medium cursor-pointer hover:underline';
                                moreEventsEl.textContent = `+${dayEvents.length - 2} more`;
                                moreEventsEl.addEventListener('click', (e) => {
                                    e.stopPropagation();
                                    showDateDetails(hiraethYear, hiraethMonth, day, dayEvents);
                                });
                                eventsContainer.appendChild(moreEventsEl);
                            }
                            cell.appendChild(eventsContainer);
                        }
                        cell.addEventListener('click', () => {
                            showDateDetails(hiraethYear, hiraethMonth, day, dayEvents);
                        });
                        monthGridDaysEl.appendChild(cell);
                    }
                } else { console.error("[renderCalendar] monthGridDaysEl not found."); }
                console.log("[renderCalendar] Calendar rendering process completed successfully.");
            } catch (error) {
                console.error("[renderCalendar] Uncaught error during rendering:", error);
                if (appContainer) {
                    appContainer.innerHTML = `<div class="p-4 text-red-500">Error rendering calendar. Check console. Details: ${error.message}</div>`;
                }
            }
        }

        function showSingleEventDetails(eventObj, year, month, day) {
            const monthName = HIRAETH_CONFIG.months[month].name;
            const dayGlobalEpoch = hiraethDateToGlobalEpochDays(year, month, day);
            const dayName = HIRAETH_CONFIG.daysOfWeek[ (dayGlobalEpoch - 1 + HIRAETH_CONFIG.daysOfWeek.length) % HIRAETH_CONFIG.daysOfWeek.length ];
            let modalDialogTitle = `Event: ${eventObj.title}`;
            let content = `<p class="text-md mb-1 text-gray-600 dark:text-gray-400">On: ${dayName}, ${day} ${monthName} ${String(year).padStart(4, '0')}</p>`;
            content += `<p class="text-lg mb-2 text-gray-700 dark:text-gray-300">Luminus Moon: ${HIRAETH_CONFIG.primaryMoon.phases[getLuminusMoonPhase(year, month, day)]}</p>`;
            content += `<h5 class="text-md font-semibold mt-3 mb-1 text-gray-800 dark:text-gray-100">Details:</h5>`;
            content += '<ul id="modal-event-list" class="list-none space-y-1 text-gray-700 dark:text-gray-300">';
            content += `
                <li>
                    <strong class="text-gray-800 dark:text-gray-200 text-xl">${eventObj.title}</strong>
                    <p class="text-xs text-gray-500 dark:text-gray-400">Original Date: ${eventObj.date}</p>
                    <p class="text-sm mt-1">${eventObj.description || 'No description.'}</p>
                    ${eventObj.group ? `<p class="text-sm mt-1"><em>(Group: ${eventObj.group})</em></p>` : ''}
                </li>`;
            content += '</ul>';
            openModal(modalDialogTitle, content);
        }

        function showDateDetails(year, month, day, events) {
            const monthName = HIRAETH_CONFIG.months[month].name;
            const dayGlobalEpoch = hiraethDateToGlobalEpochDays(year, month, day);
            const dayName = HIRAETH_CONFIG.daysOfWeek[ (dayGlobalEpoch - 1 + HIRAETH_CONFIG.daysOfWeek.length) % HIRAETH_CONFIG.daysOfWeek.length ];
            let modalDialogTitle = `${dayName}, ${day} ${monthName} ${String(year).padStart(4, '0')}`;
            let content = `<p class="text-xl mb-2 text-gray-700 dark:text-gray-300">Luminus Moon: ${HIRAETH_CONFIG.primaryMoon.phases[getLuminusMoonPhase(year, month, day)]}</p>`;
            if (events.length > 0) {
                content += `<h5 class="text-md font-semibold mt-3 mb-1 text-gray-800 dark:text-gray-100">Events on this day:</h5>`;
                content += '<ul id="modal-event-list" class="list-disc list-inside space-y-1 text-gray-700 dark:text-gray-300">';
                events.forEach(event => {
                    content += `
                        <li>
                            <strong class="text-gray-800 dark:text-gray-200">${event.title}</strong>
                            <p class="text-xs text-gray-500 dark:text-gray-400">${event.date}</p>
                            <p class="text-sm">${event.description || 'No description.'} <em>(Group: ${event.group || 'General'})</em></p>
                        </li>`;
                });
                content += '</ul>';
            } else {
                content += '<p class="text-gray-700 dark:text-gray-300">No events scheduled for this day.</p>';
            }
            openModal(modalDialogTitle, content);
        }

        function performSearch(query) {
            const searchTerm = query.toLowerCase().trim();
            const searchResultsDisplay = document.getElementById('search-results-display');
            if (!searchResultsDisplay) return;
            if (!searchTerm) {
                searchResultsDisplay.innerHTML = "<p class='text-gray-700 dark:text-gray-300'>Please enter a search term.</p>";
                return;
            }
            const allVisibleEvents = getVisibleEvents();
            const results = allVisibleEvents.filter(event =>
                (event.title && event.title.toLowerCase().includes(searchTerm)) ||
                (event.description && event.description.toLowerCase().includes(searchTerm)) ||
                (event.group && event.group.toLowerCase().includes(searchTerm)) ||
                (event.date && event.date.includes(searchTerm))
            );
            let resultsHtml = `<p class="text-sm text-gray-600 dark:text-gray-400 mb-2">${results.length} event(s) found for "${query}":</p>`;
            if (results.length > 0) {
                resultsHtml += '<ul id="search-results-list" class="space-y-2 max-h-60 overflow-y-auto">';
                results.forEach(event => {
                    resultsHtml += `
                        <li class="p-2 border-b border-gray-200 dark:border-gray-700 hover:bg-gray-50 dark:hover:bg-gray-700 rounded">
                            <strong class="text-gray-800 dark:text-gray-100">${event.title}</strong> (${event.date})
                            <p class="text-sm text-gray-600 dark:text-gray-400">${event.description || 'No description.'}</p>
                            ${event.group ? `<span class="text-xs bg-indigo-100 dark:bg-indigo-900 text-indigo-700 dark:text-indigo-300 px-1.5 py-0.5 rounded-full">${event.group}</span>` : ''}
                        </li>`;
                });
                resultsHtml += '</ul>';
            } else {
                resultsHtml += '<p class="text-gray-700 dark:text-gray-300">No events match your search.</p>';
            }
            searchResultsDisplay.innerHTML = resultsHtml;
        }

        function changeMonth(offset) {
            hiraethMonth += offset;
            if (hiraethMonth > HIRAETH_CONFIG.months.length - 1) { hiraethMonth = 0; hiraethYear++; }
            else if (hiraethMonth < 0) { hiraethMonth = HIRAETH_CONFIG.months.length - 1; hiraethYear--; }
            hiraethDay = 1;
            renderCalendar();
        }
        function goToToday() {
            hiraethYear = 76; hiraethMonth = 2; hiraethDay = 21;
            renderCalendar();
        }

        async function init() {
            if (!appContainer) {
                console.error("[init] CRITICAL: app-container element NOT FOUND.");
                document.body.innerHTML = '<p class="p-4 text-red-500 text-center">Critical error: Application container not found.</p>';
                return;
            }
            console.log("[init] app-container found successfully.");
            try {
                console.log(`[init] Initial state: Year=${hiraethYear}, Month=${hiraethMonth}, Day=${hiraethDay}, ShowMoon=${showMoonPhases}`);
                setInitialTheme();
                const essentialElements = [
                    prevMonthButton, nextMonthButton, todayButton, loreButton,
                    settingsButton, searchButton, closeModalButton, eventModal, zodiacDisplayEl
                ];
                if (essentialElements.some(el => !el)) {
                    console.error("[init] CRITICAL: One or more essential UI elements are missing.");
                    if (appContainer) appContainer.innerHTML = '<p class="p-4 text-red-500">Error: Essential UI elements missing.</p>';
                    return;
                }
                console.log("[init] All essential UI elements for listeners appear to be present.");

                prevMonthButton.addEventListener('click', () => changeMonth(-1));
                nextMonthButton.addEventListener('click', () => changeMonth(1));
                todayButton.addEventListener('click', goToToday);
                loreButton.addEventListener('click', () => openModal("Hiraeth Lore & Time", HIRAETH_CONFIG.loreText));
                settingsButton.addEventListener('click', openSettingsModal);
                searchButton.addEventListener('click', () => {
                    const searchModalContent = `
                        <div id="search-input-container" class="mb-4">
                            <input type='text' id='search-query-input' class='w-full p-2 border border-gray-300 dark:border-gray-600 rounded dark:bg-gray-700 dark:text-gray-200' placeholder='Search events by title, date, desc...'>
                            <button id="execute-search-button" class="mt-2 px-4 py-2 bg-blue-500 hover:bg-blue-600 text-white rounded-md shadow w-full">Search</button>
                        </div>
                        <div id="search-results-display"><p class="text-gray-600 dark:text-gray-400">Enter a term to search.</p></div>`;
                    openModal("Search Events", searchModalContent);
                    const executeSearchBtn = document.getElementById('execute-search-button');
                    const searchQueryInput = document.getElementById('search-query-input');
                    if(executeSearchBtn && searchQueryInput) {
                        executeSearchBtn.addEventListener('click', () => performSearch(searchQueryInput.value));
                        searchQueryInput.addEventListener('keypress', (e) => { if (e.key === 'Enter') performSearch(searchQueryInput.value); });
                    } else {
                        console.warn("[init] Search modal's input or button not found.");
                    }
                });
                closeModalButton.addEventListener('click', closeModal);
                eventModal.addEventListener('click', (e) => { if (e.target === eventModal) closeModal(); });

                await loadAllDefinedCalendars(); // This will now update `calendarLoadingStatusMessage`
                console.log(`[init] After loadAllDefinedCalendars. allCalendarsData:`, JSON.parse(JSON.stringify(allCalendarsData)));
                activeCalendars.clear();
                if (Object.keys(allCalendarsData).length > 0) {
                    console.log(`[init] Defaulting to all loaded calendars active.`);
                    Object.keys(allCalendarsData).forEach(calName => activeCalendars.add(calName));
                } else {
                    console.log(`[init] No calendars loaded, or no calendars to make active by default.`);
                }
                console.log(`[init] Active calendars set to: [${Array.from(activeCalendars).join(', ')}]`);
                renderCalendar(); // Initial render
                console.log("[init] Initialization complete.");
            } catch (error) {
                console.error("[init] CRITICAL ERROR DURING INITIALIZATION:", error);
                if (appContainer) {
                    appContainer.innerHTML = `<div class="p-4 text-red-500">Initialization error. Check console. Details: ${error.message}</div>`;
                }
            }
        }
        document.addEventListener('DOMContentLoaded', init);
    </script>
</body>
</html>